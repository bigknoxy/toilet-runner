<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pattern System Test</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
    .test-section { margin-bottom: 30px; }
    .pass { color: #4ade80; }
    .fail { color: #f87171; }
    .info { color: #60a5fa; }
    h2 { color: #fbbf24; }
  </style>
</head>
<body>
  <h1>Pattern System Integration Test</h1>
  <div id="results"></div>
  <canvas id="emojiTest" width="64" height="64" style="display:none;"></canvas>

  <script type="module">
    import { PatternPool } from './src/game/ObstaclePattern.js';
    import { DifficultyManager } from './src/game/DifficultyManager.js';
    import { PatternSequencer } from './src/game/PatternSequencer.js';

    const results = document.getElementById('results');
    let allPassed = true;

    function addResult(test, passed, message) {
      const div = document.createElement('div');
      div.className = passed ? 'pass' : 'fail';
      div.innerHTML = `${passed ? '‚úÖ' : '‚ùå'} ${test}: ${message}`;
      results.appendChild(div);
      if (!passed) allPassed = false;
    }

    function addSection(title) {
      const h2 = document.createElement('h2');
      h2.textContent = title;
      results.appendChild(h2);
    }

    addSection('Pattern Initialization');
    try {
      PatternPool.initialize();
      addResult('PatternPool.initialize()', true, 'Patterns loaded');
      const allPatterns = PatternPool.getAllPatterns();
      addResult('Pattern pool size', allPatterns.length >= 8, `${allPatterns.length} patterns`);
    } catch (e) {
      addResult('PatternPool.initialize()', false, e.message);
    }

    addSection('Pattern Validation');
    try {
      const validation = PatternPool.validateAllPatterns();
      addResult('Pattern validation', validation.invalid.length === 0, `${validation.valid.length} valid, ${validation.invalid.length} invalid`);
      validation.invalid.forEach(p => {
        addResult(`Invalid pattern ${p.id}`, false, JSON.stringify(p));
      });
    } catch (e) {
      addResult('Pattern validation', false, e.message);
    }

    addSection('Difficulty Manager');
    try {
      const tiers = DifficultyManager.getAllTiers();
      addResult('Tier count', tiers.length === 4, `${tiers.length} tiers`);
      addResult('Tier names', true, tiers.map(t => t.name).join(', '));

      const testScores = [0, 50, 100, 150, 250, 350, 500, 750];
      testScores.forEach(score => {
        const tier = DifficultyManager.getCurrentTier(score);
        addResult(`Score ${score}`, true, `Tier ${tier.name}`);
      });

      const distValid = DifficultyManager.validateDistributions();
      addResult('Distribution validation', distValid, 'All sum to 1.0');
    } catch (e) {
      addResult('Difficulty Manager', false, e.message);
    }

    addSection('Pattern Sequencer');
    try {
      PatternSequencer.initialize();
      addResult('PatternSequencer.initialize()', true, 'Sequencer initialized');

      PatternSequencer.reset();
      for (let i = 0; i < 10; i++) {
        PatternSequencer.setScore(i * 50);
        const pattern = PatternSequencer.getNextPattern();
        addResult(`Wave ${i+1}`, true, `${pattern.id} (${pattern.difficulty})`);
      }
    } catch (e) {
      addResult('Pattern Sequencer', false, e.message);
    }

    addSection('Emoji Rendering Test');
    try {
      const canvas = document.getElementById('emojiTest');
      const ctx = canvas.getContext('2d');
      ctx.font = '40px "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#000000';

      const emojis = ['üò†', 'üò´', 'üò§', 'üò°', 'üò±'];
      let emojiWorks = true;

      emojis.forEach((emoji, i) => {
        ctx.clearRect(0, 0, 64, 64);
        ctx.fillText(emoji, 32, 32);
        const imageData = ctx.getImageData(20, 20, 24, 24).data;
        const hasColor = imageData.some((v, j) => j % 4 !== 3 && v !== 0 && v !== 255);
        addResult(`Emoji ${emoji}`, hasColor, hasColor ? 'Rendering with color' : 'May be missing font');
        if (!hasColor) emojiWorks = false;
      });
    } catch (e) {
      addResult('Emoji rendering', false, e.message);
    }

    addSection('Overall');
    addResult('All tests', allPassed, allPassed ? 'PASSED' : 'FAILED');

    if (allPassed) {
      console.log('‚úÖ All tests passed');
    } else {
      console.error('‚ùå Some tests failed');
    }
  </script>
</body>
</html>
